name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate action.yml
        run: |
          echo "Validating action.yml..."
          if [ ! -f action.yml ]; then
            echo "::error::action.yml not found"
            exit 1
          fi
          # Check required fields
          for field in name description; do
            if ! grep -q "^${field}:" action.yml; then
              echo "::error::Missing required field: ${field}"
              exit 1
            fi
          done
          # Check branding
          if ! grep -q "^branding:" action.yml; then
            echo "::error::Missing branding section (required for Marketplace)"
            exit 1
          fi
          echo "âœ… action.yml is valid"

      - name: Test action Docker build
        run: |
          echo "Building action Docker image..."
          docker build -f src/Dockerfile.action src/
          echo "âœ… Docker image builds successfully"

      - name: Generate release notes
        id: notes
        run: |
          TAG="${GITHUB_REF_NAME}"
          cat > /tmp/release-notes.md << 'NOTES'
          ## ðŸ›¡ï¸ Anchor Security Scanner

          Enterprise-grade security scanning for CI/CD pipelines.

          ### Scanners
          - ðŸ”‘ **Secrets Detection** â€” 23 credential patterns (AWS, GitHub, Stripe, etc.)
          - ðŸ” **SAST** â€” 30+ static analysis rules (JS/TS/Python)
          - ðŸ“¦ **Dependencies** â€” npm audit, Dockerfile security
          - ðŸ¤– **AI Security** â€” 13 ML/LLM-specific rules

          ### Features
          - Zero-config: works out of the box
          - SARIF output â†’ GitHub Security tab
          - Inline PR annotations
          - Configurable severity thresholds
          - 95+ security modules, 25 world-first features

          ### Quick Start
          ```yaml
          - uses: toddyg1981-png/Anchor-AI-Guard@v1
          ```

          See [README](https://github.com/toddyg1981-png/Anchor-AI-Guard#readme) for full documentation.
          NOTES

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: /tmp/release-notes.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update major version tag
        run: |
          TAG="${GITHUB_REF_NAME}"
          MAJOR=$(echo "${TAG}" | sed -n 's/^\(v[0-9]\+\).*/\1/p')
          if [ -n "${MAJOR}" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -fa "${MAJOR}" -m "Update ${MAJOR} to ${TAG}"
            git push origin "${MAJOR}" --force
            echo "âœ… Updated ${MAJOR} tag to point to ${TAG}"
          fi

import React, { useState } from 'react';

// ============================================================================
// VULNERABILITY MANAGEMENT
// ============================================================================
// Scan, prioritize, track, and remediate vulnerabilities across your estate
// CVE tracking, CVSS scoring, SLA management, patch orchestration
// ============================================================================

interface Vulnerability {
  id: string;
  cveId: string;
  title: string;
  description: string;
  cvssScore: number;
  severity: 'critical' | 'high' | 'medium' | 'low';
  affectedAssets: number;
  discoveredDate: string;
  dueDate: string;
  status: 'open' | 'in_progress' | 'remediated' | 'accepted_risk' | 'false_positive';
  exploitAvailable: boolean;
  inTheWild: boolean;
  cisaKev: boolean;
  assignee?: string;
  vendor: string;
  patchAvailable: boolean;
}

interface Asset {
  id: string;
  name: string;
  type: 'server' | 'workstation' | 'network' | 'application' | 'container';
  os: string;
  criticalVulns: number;
  highVulns: number;
  mediumVulns: number;
  lowVulns: number;
  lastScan: string;
  riskScore: number;
}

interface ScanProfile {
  id: string;
  name: string;
  schedule: string;
  targetCount: number;
  lastRun: string;
  nextRun: string;
  status: 'active' | 'paused';
}

export const VulnerabilityManagement: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'dashboard' | 'vulnerabilities' | 'assets' | 'scans'>('dashboard');
  const [severityFilter, setSeverityFilter] = useState<string>('all');

  const vulnerabilities: Vulnerability[] = [
    { id: 'v-1', cveId: 'CVE-2026-0001', title: 'Critical RCE in OpenSSL', description: 'Remote code execution vulnerability in OpenSSL', cvssScore: 9.8, severity: 'critical', affectedAssets: 45, discoveredDate: '2026-02-01', dueDate: '2026-02-08', status: 'in_progress', exploitAvailable: true, inTheWild: true, cisaKev: true, assignee: 'Security Team', vendor: 'OpenSSL', patchAvailable: true },
    { id: 'v-2', cveId: 'CVE-2026-0002', title: 'SQL Injection in PostgreSQL', description: 'SQL injection in specific query handler', cvssScore: 8.5, severity: 'high', affectedAssets: 12, discoveredDate: '2026-02-02', dueDate: '2026-02-16', status: 'open', exploitAvailable: true, inTheWild: false, cisaKev: false, vendor: 'PostgreSQL', patchAvailable: true },
    { id: 'v-3', cveId: 'CVE-2025-44228', title: 'Log4Shell Variant', description: 'New variant of Log4j vulnerability', cvssScore: 10.0, severity: 'critical', affectedAssets: 3, discoveredDate: '2026-01-15', dueDate: '2026-01-22', status: 'remediated', exploitAvailable: true, inTheWild: true, cisaKev: true, vendor: 'Apache', patchAvailable: true },
    { id: 'v-4', cveId: 'CVE-2026-0003', title: 'XSS in React Component', description: 'Cross-site scripting in third-party component', cvssScore: 6.5, severity: 'medium', affectedAssets: 8, discoveredDate: '2026-02-03', dueDate: '2026-03-03', status: 'open', exploitAvailable: false, inTheWild: false, cisaKev: false, vendor: 'npm', patchAvailable: true },
    { id: 'v-5', cveId: 'CVE-2026-0004', title: 'Privilege Escalation in Linux Kernel', description: 'Local privilege escalation', cvssScore: 7.8, severity: 'high', affectedAssets: 67, discoveredDate: '2026-02-04', dueDate: '2026-02-18', status: 'open', exploitAvailable: true, inTheWild: true, cisaKev: true, vendor: 'Linux', patchAvailable: true },
    { id: 'v-6', cveId: 'CVE-2026-0005', title: 'Information Disclosure in Node.js', description: 'Memory leak exposing sensitive data', cvssScore: 5.3, severity: 'medium', affectedAssets: 23, discoveredDate: '2026-02-04', dueDate: '2026-03-04', status: 'open', exploitAvailable: false, inTheWild: false, cisaKev: false, vendor: 'Node.js', patchAvailable: false },
  ];

  const assets: Asset[] = [
    { id: 'a-1', name: 'prod-web-01', type: 'server', os: 'Ubuntu 22.04', criticalVulns: 2, highVulns: 5, mediumVulns: 12, lowVulns: 34, lastScan: '2026-02-04T06:00:00Z', riskScore: 85 },
    { id: 'a-2', name: 'prod-db-01', type: 'server', os: 'Ubuntu 22.04', criticalVulns: 1, highVulns: 3, mediumVulns: 8, lowVulns: 15, lastScan: '2026-02-04T06:00:00Z', riskScore: 72 },
    { id: 'a-3', name: 'prod-api-cluster', type: 'container', os: 'Alpine 3.18', criticalVulns: 0, highVulns: 2, mediumVulns: 5, lowVulns: 10, lastScan: '2026-02-04T06:00:00Z', riskScore: 45 },
    { id: 'a-4', name: 'corporate-fw-01', type: 'network', os: 'Palo Alto PAN-OS', criticalVulns: 0, highVulns: 1, mediumVulns: 2, lowVulns: 5, lastScan: '2026-02-04T06:00:00Z', riskScore: 28 },
  ];

  const scanProfiles: ScanProfile[] = [
    { id: 'sp-1', name: 'Full Infrastructure Scan', schedule: 'Weekly', targetCount: 156, lastRun: '2026-02-04T06:00:00Z', nextRun: '2026-02-11T06:00:00Z', status: 'active' },
    { id: 'sp-2', name: 'Critical Assets Daily', schedule: 'Daily', targetCount: 12, lastRun: '2026-02-04T06:00:00Z', nextRun: '2026-02-05T06:00:00Z', status: 'active' },
    { id: 'sp-3', name: 'Container Image Scan', schedule: 'On Deploy', targetCount: 45, lastRun: '2026-02-04T11:30:00Z', nextRun: 'On next deploy', status: 'active' },
  ];

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'bg-red-500/20 text-red-400 border-red-500';
      case 'high': return 'bg-orange-500/20 text-orange-400 border-orange-500';
      case 'medium': return 'bg-yellow-500/20 text-yellow-400 border-yellow-500';
      case 'low': return 'bg-blue-500/20 text-blue-400 border-blue-500';
      default: return 'bg-gray-500/20 text-gray-400 border-gray-500';
    }
  };

  const getCvssColor = (score: number) => {
    if (score >= 9.0) return 'text-red-400';
    if (score >= 7.0) return 'text-orange-400';
    if (score >= 4.0) return 'text-yellow-400';
    return 'text-blue-400';
  };

  const filteredVulns = severityFilter === 'all' 
    ? vulnerabilities 
    : vulnerabilities.filter(v => v.severity === severityFilter);

  const criticalCount = vulnerabilities.filter(v => v.severity === 'critical' && v.status === 'open').length;
  const overdueSLA = vulnerabilities.filter(v => new Date(v.dueDate) < new Date() && v.status === 'open').length;

  return (
    <div className="min-h-screen bg-[#0a0a0f] text-white p-6">
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold mb-2">üîç Vulnerability Management</h1>
          <p className="text-gray-400">Scan, prioritize, and remediate vulnerabilities</p>
        </div>
        <button className="px-6 py-3 bg-cyan-500 hover:bg-cyan-600 rounded-lg font-bold">
          + New Scan
        </button>
      </div>

      {/* Alert Banners */}
      {criticalCount > 0 && (
        <div className="mb-4 p-4 bg-red-500/10 border border-red-500 rounded-xl flex items-center gap-3">
          <span className="text-2xl">üö®</span>
          <div className="flex-1">
            <div className="font-bold text-red-400">{criticalCount} Critical Vulnerabilities</div>
            <div className="text-sm text-gray-400">Require immediate attention</div>
          </div>
        </div>
      )}
      {overdueSLA > 0 && (
        <div className="mb-4 p-4 bg-orange-500/10 border border-orange-500 rounded-xl flex items-center gap-3">
          <span className="text-2xl">‚è∞</span>
          <div className="flex-1">
            <div className="font-bold text-orange-400">{overdueSLA} SLA Breaches</div>
            <div className="text-sm text-gray-400">Vulnerabilities past due date</div>
          </div>
        </div>
      )}

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
        <div className="bg-gray-900/50 border border-gray-800 rounded-xl p-4 text-center">
          <div className="text-3xl font-bold text-cyan-400">{vulnerabilities.length}</div>
          <div className="text-sm text-gray-400">Total Vulns</div>
        </div>
        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-center">
          <div className="text-3xl font-bold text-red-400">{vulnerabilities.filter(v => v.severity === 'critical').length}</div>
          <div className="text-sm text-gray-400">Critical</div>
        </div>
        <div className="bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 text-center">
          <div className="text-3xl font-bold text-orange-400">{vulnerabilities.filter(v => v.severity === 'high').length}</div>
          <div className="text-sm text-gray-400">High</div>
        </div>
        <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 text-center">
          <div className="text-3xl font-bold text-yellow-400">{vulnerabilities.filter(v => v.severity === 'medium').length}</div>
          <div className="text-sm text-gray-400">Medium</div>
        </div>
        <div className="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 text-center">
          <div className="text-3xl font-bold text-purple-400">{vulnerabilities.filter(v => v.cisaKev).length}</div>
          <div className="text-sm text-gray-400">CISA KEV</div>
        </div>
        <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4 text-center">
          <div className="text-3xl font-bold text-green-400">{vulnerabilities.filter(v => v.status === 'remediated').length}</div>
          <div className="text-sm text-gray-400">Remediated</div>
        </div>
        <div className="bg-gray-900/50 border border-gray-800 rounded-xl p-4 text-center">
          <div className="text-3xl font-bold text-gray-400">{assets.length}</div>
          <div className="text-sm text-gray-400">Assets</div>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-6 border-b border-gray-800 pb-2">
        {[
          { id: 'dashboard', label: 'üìä Dashboard' },
          { id: 'vulnerabilities', label: 'üêõ Vulnerabilities' },
          { id: 'assets', label: 'üíª Assets' },
          { id: 'scans', label: 'üîç Scans' }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id as any)}
            className={`px-4 py-2 rounded-lg transition-colors ${
              activeTab === tab.id
                ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500'
                : 'text-gray-400 hover:text-white hover:bg-gray-800'
            }`}
          >
            {tab.label}
          </button>
        ))}
      </div>

      {/* Dashboard Tab */}
      {activeTab === 'dashboard' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-gray-900/50 border border-gray-800 rounded-xl p-6">
            <h3 className="font-semibold mb-4">üî• Top Priority Vulnerabilities</h3>
            <div className="space-y-3">
              {vulnerabilities
                .filter(v => v.status === 'open' || v.status === 'in_progress')
                .sort((a, b) => b.cvssScore - a.cvssScore)
                .slice(0, 5)
                .map(vuln => (
                  <div key={vuln.id} className={`p-3 rounded-lg border ${getSeverityColor(vuln.severity)}`}>
                    <div className="flex items-center justify-between mb-1">
                      <span className="font-mono text-sm text-cyan-400">{vuln.cveId}</span>
                      <span className={`font-bold ${getCvssColor(vuln.cvssScore)}`}>{vuln.cvssScore}</span>
                    </div>
                    <div className="text-sm">{vuln.title}</div>
                    <div className="flex items-center gap-2 mt-2">
                      {vuln.exploitAvailable && <span className="text-xs bg-red-500/20 text-red-400 px-1 rounded">Exploit</span>}
                      {vuln.cisaKev && <span className="text-xs bg-purple-500/20 text-purple-400 px-1 rounded">CISA KEV</span>}
                      {vuln.inTheWild && <span className="text-xs bg-orange-500/20 text-orange-400 px-1 rounded">In the Wild</span>}
                    </div>
                  </div>
                ))}
            </div>
          </div>

          <div className="bg-gray-900/50 border border-gray-800 rounded-xl p-6">
            <h3 className="font-semibold mb-4">üìà Vulnerability Trend (30 days)</h3>
            <div className="h-48 flex items-end justify-around gap-1">
              {Array.from({ length: 30 }, (_, i) => {
                const critical = Math.floor(Math.random() * 5);
                const high = Math.floor(Math.random() * 10);
                return (
                  <div key={i} className="flex flex-col-reverse w-2">
                    <div className="bg-red-500" style={{ height: `${critical * 8}px` }} />
                    <div className="bg-orange-500" style={{ height: `${high * 4}px` }} />
                  </div>
                );
              })}
            </div>
            <div className="flex items-center justify-center gap-4 mt-4 text-xs">
              <div className="flex items-center gap-1"><div className="w-3 h-3 bg-red-500 rounded" /> Critical</div>
              <div className="flex items-center gap-1"><div className="w-3 h-3 bg-orange-500 rounded" /> High</div>
            </div>
          </div>
        </div>
      )}

      {/* Vulnerabilities Tab */}
      {activeTab === 'vulnerabilities' && (
        <div>
          <div className="flex gap-2 mb-4">
            {['all', 'critical', 'high', 'medium', 'low'].map(sev => (
              <button
                key={sev}
                onClick={() => setSeverityFilter(sev)}
                className={`px-3 py-1 rounded text-sm ${
                  severityFilter === sev ? 'bg-cyan-500 text-white' : 'bg-gray-800 text-gray-400'
                }`}
              >
                {sev.charAt(0).toUpperCase() + sev.slice(1)}
              </button>
            ))}
          </div>
          <div className="bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
            <table className="w-full">
              <thead>
                <tr className="text-left text-sm text-gray-400 border-b border-gray-800">
                  <th className="p-4">CVE</th>
                  <th className="p-4">Title</th>
                  <th className="p-4">CVSS</th>
                  <th className="p-4">Assets</th>
                  <th className="p-4">Due Date</th>
                  <th className="p-4">Status</th>
                  <th className="p-4">Flags</th>
                </tr>
              </thead>
              <tbody>
                {filteredVulns.map(vuln => (
                  <tr key={vuln.id} className="border-b border-gray-800/50 hover:bg-gray-800/30">
                    <td className="p-4 font-mono text-sm text-cyan-400">{vuln.cveId}</td>
                    <td className="p-4">{vuln.title}</td>
                    <td className="p-4">
                      <span className={`font-bold ${getCvssColor(vuln.cvssScore)}`}>{vuln.cvssScore}</span>
                    </td>
                    <td className="p-4">{vuln.affectedAssets}</td>
                    <td className={`p-4 ${new Date(vuln.dueDate) < new Date() && vuln.status === 'open' ? 'text-red-400' : ''}`}>
                      {vuln.dueDate}
                    </td>
                    <td className="p-4">
                      <span className={`px-2 py-1 rounded text-xs ${
                        vuln.status === 'remediated' ? 'bg-green-500/20 text-green-400' :
                        vuln.status === 'in_progress' ? 'bg-cyan-500/20 text-cyan-400' :
                        'bg-red-500/20 text-red-400'
                      }`}>
                        {vuln.status.replace('_', ' ')}
                      </span>
                    </td>
                    <td className="p-4">
                      <div className="flex gap-1">
                        {vuln.exploitAvailable && <span title="Exploit Available">üí•</span>}
                        {vuln.cisaKev && <span title="CISA KEV">üèõÔ∏è</span>}
                        {vuln.inTheWild && <span title="Exploited in Wild">üî•</span>}
                        {vuln.patchAvailable && <span title="Patch Available">‚úÖ</span>}
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Assets Tab */}
      {activeTab === 'assets' && (
        <div className="bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="text-left text-sm text-gray-400 border-b border-gray-800">
                <th className="p-4">Asset</th>
                <th className="p-4">Type</th>
                <th className="p-4">OS</th>
                <th className="p-4">Critical</th>
                <th className="p-4">High</th>
                <th className="p-4">Medium</th>
                <th className="p-4">Low</th>
                <th className="p-4">Risk Score</th>
                <th className="p-4">Last Scan</th>
              </tr>
            </thead>
            <tbody>
              {assets.sort((a, b) => b.riskScore - a.riskScore).map(asset => (
                <tr key={asset.id} className="border-b border-gray-800/50 hover:bg-gray-800/30">
                  <td className="p-4 font-medium">{asset.name}</td>
                  <td className="p-4">{asset.type}</td>
                  <td className="p-4 text-gray-400">{asset.os}</td>
                  <td className="p-4 text-red-400 font-bold">{asset.criticalVulns}</td>
                  <td className="p-4 text-orange-400">{asset.highVulns}</td>
                  <td className="p-4 text-yellow-400">{asset.mediumVulns}</td>
                  <td className="p-4 text-blue-400">{asset.lowVulns}</td>
                  <td className="p-4">
                    <div className={`font-bold ${
                      asset.riskScore >= 70 ? 'text-red-400' :
                      asset.riskScore >= 40 ? 'text-yellow-400' : 'text-green-400'
                    }`}>
                      {asset.riskScore}
                    </div>
                  </td>
                  <td className="p-4 text-sm text-gray-500">{new Date(asset.lastScan).toLocaleString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Scans Tab */}
      {activeTab === 'scans' && (
        <div className="space-y-4">
          {scanProfiles.map(profile => (
            <div key={profile.id} className="bg-gray-900/50 border border-gray-800 rounded-xl p-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h3 className="font-semibold text-lg">{profile.name}</h3>
                  <div className="text-sm text-gray-500">Schedule: {profile.schedule} ‚Ä¢ Targets: {profile.targetCount}</div>
                </div>
                <span className={`px-3 py-1 rounded ${
                  profile.status === 'active' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'
                }`}>
                  {profile.status}
                </span>
              </div>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div className="p-3 bg-gray-800/50 rounded-lg">
                  <div className="text-gray-500">Last Run</div>
                  <div>{new Date(profile.lastRun).toLocaleString()}</div>
                </div>
                <div className="p-3 bg-gray-800/50 rounded-lg">
                  <div className="text-gray-500">Next Run</div>
                  <div>{profile.nextRun}</div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default VulnerabilityManagement;

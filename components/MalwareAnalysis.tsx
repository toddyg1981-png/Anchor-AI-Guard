import React, { useState, useEffect } from 'react';
import { backendApi } from '../utils/backendApi';

type Tab = 'sandbox' | 'samples' | 'yara-rules' | 'threat-intel';

const MalwareAnalysis: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<Tab>('sandbox');

  const tabs: { key: Tab; label: string }[] = [
    { key: 'sandbox', label: 'Sandbox' },
    { key: 'samples', label: 'Samples' },
    { key: 'yara-rules', label: 'YARA Rules' },
    { key: 'threat-intel', label: 'Threat Intel' },
  ];

  const stats = [
    { label: 'Samples analyzed (24h)', value: 94 },
    { label: 'IOCs extracted', value: 312 },
    { label: 'Auto detonations', value: 61 },
    { label: 'Families tracked', value: 44 },
  ];

  const detonations = [
    { id: 'd-1', file: 'Sample-445.exe', hash: 'a3f1c7…e90b2', verdict: 'Malicious', family: 'LockBit 3.0', status: 'Completed', time: '2h ago' },
    { id: 'd-2', file: 'macro.docm', hash: 'b8d4e2…17fc8', verdict: 'Suspicious', family: 'Unknown', status: 'Completed', time: '4h ago' },
    { id: 'd-3', file: 'loader.bin', hash: 'c12a09…d43ef', verdict: 'Malicious', family: 'QakBot', status: 'Completed', time: '6h ago' },
    { id: 'd-4', file: 'invoice.pdf', hash: 'ff9831…ab012', verdict: 'Clean', family: '—', status: 'Running', time: '12m ago' },
  ];

  const sampleRepo = [
    { sha256: 'a3f1c7d8e4b92f0156c8d9ea3b7f21e90b2c…', type: 'PE32', ratio: '58/72', submitted: '2026-02-07' },
    { sha256: 'b8d4e2c1a7f53019de6b84c7f2a9103817fc8…', type: 'Office', ratio: '34/72', submitted: '2026-02-07' },
    { sha256: 'c12a0976e3d8f4b62a0cf197b5e8d2a0d43ef…', type: 'ELF', ratio: '61/72', submitted: '2026-02-06' },
    { sha256: '91e7b34a0c5f82d6e19ba47c6d3f0a8e27d10…', type: 'DLL', ratio: '45/72', submitted: '2026-02-06' },
  ];

  const yaraRules = [
    { name: 'RULE_LockBit3_Loader', matches: 14, lastTriggered: '2026-02-07 09:12', status: 'Active' },
    { name: 'RULE_QakBot_C2_Beacon', matches: 9, lastTriggered: '2026-02-07 07:45', status: 'Active' },
    { name: 'RULE_CobaltStrike_Shellcode', matches: 22, lastTriggered: '2026-02-06 23:30', status: 'Active' },
    { name: 'RULE_Emotet_Macro_Dropper', matches: 5, lastTriggered: '2026-02-05 18:10', status: 'Disabled' },
  ];

  const threatIntel = [
    { ioc: '185.220.101.34', type: 'IP', source: 'Sandbox d-1', mitre: 'T1071.001 – Web Protocols', severity: 'Critical' },
    { ioc: 'evil-cdn.darkops.ru', type: 'Domain', source: 'Sandbox d-3', mitre: 'T1105 – Ingress Tool Transfer', severity: 'High' },
    { ioc: 'a3f1c7d8e4b92f01…', type: 'SHA256', source: 'Sandbox d-1', mitre: 'T1486 – Data Encrypted for Impact', severity: 'Critical' },
    { ioc: '10.0.0.0/8 lateral', type: 'IP Range', source: 'Sandbox d-3', mitre: 'T1021 – Remote Services', severity: 'Medium' },
  ];

  useEffect(() => {
    loadDashboard();
  }, []);

  const loadDashboard = async () => {
    try {
      setLoading(true);
      await backendApi.modules.getDashboard('malware-analysis');
    } catch {
      // use static data on error
    } finally {
      setLoading(false);
    }
  };

  const handleAnalyze = async () => {
    try {
      setAnalyzing(true);
      setAnalysisResult(null);
      const res = await backendApi.modules.analyze(
        'malware-analysis',
        'Analyze recent malware samples for IOCs, TTPs, and attribution. Suggest detection rules.'
      );
      setAnalysisResult(typeof res === 'string' ? res : JSON.stringify(res, null, 2));
    } catch {
      setAnalysisResult('Analysis request failed. Please try again.');
    } finally {
      setAnalyzing(false);
    }
  };

  const verdictColor = (v: string) =>
    v === 'Malicious' ? 'text-red-400' : v === 'Suspicious' ? 'text-yellow-400' : 'text-green-400';

  const severityColor = (s: string) =>
    s === 'Critical' ? 'text-red-400' : s === 'High' ? 'text-orange-400' : 'text-yellow-400';

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-pink-400" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-900 text-white p-6 space-y-6">
      {/* Header */}
      <header className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-transparent bg-clip-text bg-linear-to-r from-pink-400 to-red-400">Malware Analysis</h1>
          <p className="text-slate-400">Sandbox detonations, static/dynamic analysis, and IOC extraction.</p>
        </div>
        <div className="flex items-center gap-3">
          <button onClick={handleAnalyze} disabled={analyzing}
            className="bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 disabled:opacity-50 px-4 py-2 rounded-xl text-sm font-medium transition-all">
            {analyzing ? 'Analyzing…' : '✦ AI Analyze'}
          </button>
          <div className="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-sm text-slate-300">Sandbox: Online</div>
        </div>
      </header>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {stats.map(card => (
          <div key={card.label} className="bg-slate-800 border border-slate-700 rounded-xl p-4">
            <div className="text-slate-400 text-sm">{card.label}</div>
            <div className="text-2xl font-semibold mt-1">{card.value}</div>
          </div>
        ))}
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b border-slate-700 pb-2">
        {tabs.map(t => (
          <button key={t.key} onClick={() => setActiveTab(t.key)}
            className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${activeTab === t.key ? 'bg-slate-800 text-white border border-slate-700 border-b-0' : 'text-slate-400 hover:text-white'}`}>
            {t.label}
          </button>
        ))}
      </div>

      {/* Sandbox Tab */}
      {activeTab === 'sandbox' && (
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-semibold">Sandbox Detonations</h2>
            <span className="text-xs text-slate-400">{detonations.length} detonations</span>
          </div>
          <div className="space-y-3">
            {detonations.map(d => (
              <div key={d.id} className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm flex items-center justify-between">
                <div className="space-y-1">
                  <div className="font-semibold">{d.file}</div>
                  <div className="text-xs text-slate-500 font-mono">{d.hash}</div>
                  <div className="text-xs text-slate-400">Family: {d.family}</div>
                </div>
                <div className="text-right space-y-1">
                  <div className={`font-semibold ${verdictColor(d.verdict)}`}>{d.verdict}</div>
                  <div className={`text-xs ${d.status === 'Running' ? 'text-blue-400 animate-pulse' : 'text-green-300'}`}>{d.status}</div>
                  <div className="text-xs text-slate-400">{d.time}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Samples Tab */}
      {activeTab === 'samples' && (
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-semibold">Sample Repository</h2>
            <span className="text-xs text-slate-400">{sampleRepo.length} samples</span>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead><tr className="text-slate-400 text-left border-b border-slate-700">
                <th className="pb-2">SHA256</th><th className="pb-2">Type</th><th className="pb-2">Detection</th><th className="pb-2">Submitted</th>
              </tr></thead>
              <tbody>
                {sampleRepo.map((s, i) => (
                  <tr key={i} className="border-b border-slate-700/50">
                    <td className="py-2 font-mono text-xs text-slate-300">{s.sha256}</td>
                    <td className="py-2">{s.type}</td>
                    <td className="py-2 text-red-400">{s.ratio}</td>
                    <td className="py-2 text-slate-400">{s.submitted}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* YARA Rules Tab */}
      {activeTab === 'yara-rules' && (
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-semibold">YARA Rules</h2>
            <span className="text-xs text-slate-400">{yaraRules.length} rules</span>
          </div>
          <div className="space-y-3">
            {yaraRules.map((r, i) => (
              <div key={i} className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm flex items-center justify-between">
                <div className="space-y-1">
                  <div className="font-semibold font-mono">{r.name}</div>
                  <div className="text-xs text-slate-400">Last triggered: {r.lastTriggered}</div>
                </div>
                <div className="text-right space-y-1">
                  <div className="text-lg font-semibold">{r.matches} <span className="text-xs text-slate-400">matches</span></div>
                  <div className={`text-xs ${r.status === 'Active' ? 'text-green-400' : 'text-slate-500'}`}>{r.status}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Threat Intel Tab */}
      {activeTab === 'threat-intel' && (
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-semibold">Linked IOCs &amp; MITRE ATT&amp;CK Mapping</h2>
            <span className="text-xs text-slate-400">{threatIntel.length} indicators</span>
          </div>
          <div className="space-y-3">
            {threatIntel.map((t, i) => (
              <div key={i} className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm flex items-center justify-between">
                <div className="space-y-1">
                  <div className="font-semibold font-mono">{t.ioc}</div>
                  <div className="text-xs text-slate-400">{t.type} · Source: {t.source}</div>
                  <div className="text-xs text-blue-400">{t.mitre}</div>
                </div>
                <div className={`text-sm font-semibold ${severityColor(t.severity)}`}>{t.severity}</div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Analysis Result */}
      {analysisResult && (
        <div className="bg-slate-800 border border-pink-500/30 rounded-xl p-4">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-lg font-semibold text-pink-400">✦ AI Analysis Result</h2>
            <button onClick={() => setAnalysisResult(null)} className="text-slate-400 hover:text-white text-sm">Dismiss</button>
          </div>
          <pre className="text-sm text-slate-300 whitespace-pre-wrap font-mono bg-slate-900 rounded-lg p-3 max-h-64 overflow-y-auto">{analysisResult}</pre>
        </div>
      )}
    </div>
  );
};

export default MalwareAnalysis;
